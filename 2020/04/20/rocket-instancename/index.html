<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>RocketMQ消费者设置了instanceName属性后消息竟不翼而飞 | 墨鱼🦑的个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RocketMQ消费者设置了instanceName属性后消息竟不翼而飞</h1><a id="logo" href="/.">墨鱼🦑的个人博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">RocketMQ消费者设置了instanceName属性后消息竟不翼而飞</h1><div class="post-meta">2020-04-20</div><div class="post-content"><p>RocketMQ使用过程中为了快速搭建消费服务，于是在<strong>同一个</strong>机器<strong>集群消费</strong>的方式起了多个消费者实例，结果发现部分消息没被消费到！本文是对问题产生原因的跟踪和分析，下面会将项目中遇到的问题简化成官方demo来说明。</p>
<span id="more"></span>
<h1 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h1><h2 id="生产者代码"><a href="#生产者代码" class="headerlink" title="生产者代码"></a>生产者代码</h2><p><code>Producer.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Instantiate with a producer group name.</span></span><br><span class="line"><span class="comment"> * 默认分配4个消息队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(<span class="string">&quot;producer_group&quot;</span>);</span><br><span class="line"></span><br><span class="line">producer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Launch the instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">producer.start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;TopicTest&quot;</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">            <span class="string">&quot;TagA&quot;</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">            (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(msg);</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">&quot;%s%n&quot;</span>, sendResult);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>启动一个producer实例发送10条消息到4个消息队列。</p>
</blockquote>
<p>消息发送情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">消息发送结果: queueId=<span class="number">2</span>,消息内容: Hello RocketMQ <span class="number">0</span></span><br><span class="line">消息发送结果: queueId=<span class="number">3</span>,消息内容: Hello RocketMQ <span class="number">1</span></span><br><span class="line">消息发送结果: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">2</span></span><br><span class="line">消息发送结果: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">3</span></span><br><span class="line">消息发送结果: queueId=<span class="number">2</span>,消息内容: Hello RocketMQ <span class="number">4</span></span><br><span class="line">消息发送结果: queueId=<span class="number">3</span>,消息内容: Hello RocketMQ <span class="number">5</span></span><br><span class="line">消息发送结果: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">6</span></span><br><span class="line">消息发送结果: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">7</span></span><br><span class="line">消息发送结果: queueId=<span class="number">2</span>,消息内容: Hello RocketMQ <span class="number">8</span></span><br><span class="line">消息发送结果: queueId=<span class="number">3</span>,消息内容: Hello RocketMQ <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>从发送结果可以看出消息发送的队列分配情况如下所示：<br><img src="https://img-blog.csdnimg.cn/20210429103000197.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4NTE1MTU1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="消费者代码"><a href="#消费者代码" class="headerlink" title="消费者代码"></a>消费者代码</h2><p><code>Consumer.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Instantiate with specified consumer group name.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(<span class="string">&quot;consumer_group&quot;</span>);</span><br><span class="line"></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;localhost:9876&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//自定义instanceName</span></span><br><span class="line">        consumer.setInstanceName(<span class="string">&quot;XUJIAN_MACBOOK&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Subscribe one more more topics to consume.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.subscribe(<span class="string">&quot;TopicTest&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *  Register callback to execute on arrival of messages fetched from brokers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> <span class="title class_">MessageListenerConcurrently</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span><br><span class="line"><span class="params">                ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">                System.out.printf(<span class="string">&quot;%s Receive New Messages: %s %n&quot;</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                System.out.printf(<span class="string">&quot;msgBody: %s %n&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>(msgs.get(<span class="number">0</span>).getBody()));</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *  Launch the consumer instance.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.start();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>本地启动两个消费者实例，即consumer启动两次，设置为<strong>集群消费</strong>模式，且两个消费者实例属于<strong>同一个消费者组</strong>。</p>
</blockquote>
<h2 id="紊乱的消费结果"><a href="#紊乱的消费结果" class="headerlink" title="紊乱的消费结果"></a>紊乱的消费结果</h2><p>consumer1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ConsumeMessageThread_11 接收到新消息: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">2</span></span><br><span class="line">ConsumeMessageThread_14 接收到新消息: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">6</span></span><br><span class="line">ConsumeMessageThread_15 接收到新消息: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">3</span></span><br><span class="line">ConsumeMessageThread_16 接收到新消息: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>consumer2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ConsumeMessageThread_6 接收到新消息: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">2</span></span><br><span class="line">ConsumeMessageThread_7 接收到新消息: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">6</span></span><br><span class="line">ConsumeMessageThread_8 接收到新消息: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">3</span></span><br><span class="line">ConsumeMessageThread_9 接收到新消息: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>从消费结果可以看出消息消费的队列分配情况如下所示：<br><img src="https://img-blog.csdnimg.cn/20210429110729318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4NTE1MTU1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<blockquote>
<p>两个消费者消费了相同队列的相同消息，且部分消息没被消费到。这和预期的<strong>集群消费</strong>模式下消费者组内的消费者<strong>均分</strong>消息队列不符！</p>
</blockquote>
<h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>当发现消费者消费异常时，首先应该排查消费负载均衡是否正常。</p>
<h2 id="消费负载均衡"><a href="#消费负载均衡" class="headerlink" title="消费负载均衡"></a>消费负载均衡</h2><blockquote>
<p>集群消费的时候会根据统一消费者组内<strong>消费者的数量</strong>、<strong>队列数量</strong>以及不同的<strong>策略</strong>来为每个消费者分配要消费的消息。</p>
</blockquote>
<p>消费者的默认队列分配策略是“<strong>均分</strong>”，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor specifying consumer group.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> consumerGroup Consumer group.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DefaultMQPushConsumer</span><span class="params">(<span class="keyword">final</span> String consumerGroup)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="literal">null</span>, consumerGroup, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">AllocateMessageQueueAveragely</span>());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>AllocateMessageQueueAveragely</code>就是<strong>平均分配</strong>策略，其他的还有随机等，均实现了<code>AllocateMessageQueueStrategy</code>接口。</p>
<p><code>RebalanceImpl.java</code></p>
<blockquote>
<p>该类就是消息消费均衡类。</p>
</blockquote>
<p>相关核心源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doRebalance</span><span class="params">(<span class="keyword">final</span> <span class="type">boolean</span> isOrder)</span> &#123;</span><br><span class="line">        Map&lt;String, SubscriptionData&gt; subTable = <span class="built_in">this</span>.getSubscriptionInner();</span><br><span class="line">        <span class="keyword">if</span> (subTable != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, SubscriptionData&gt; entry : subTable.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//根据topic进行reblance</span></span><br><span class="line">                   <span class="built_in">this</span>.rebalanceByTopic(topic, isOrder);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                        log.warn(<span class="string">&quot;rebalanceByTopic Exception&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.truncateMessageQueueNotMyTopic();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rebalanceByTopic</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="type">boolean</span> isOrder)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//获取分配的结果</span></span><br><span class="line">    allocateResult = strategy.allocate(</span><br><span class="line">                            <span class="built_in">this</span>.consumerGroup,</span><br><span class="line">                            <span class="built_in">this</span>.mQClientFactory.getClientId(),</span><br><span class="line">                            mqAll,</span><br><span class="line">                            cidAll);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又回到<code>AllocateMessageQueueAveragely.java</code>，上文提到这个类的策略是均分，那就来看看他是怎么做的。源码如下：<br><code>AllocateMessageQueueAveragely.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title function_">allocate</span><span class="params">(String consumerGroup<span class="comment">/*消费者组*/</span>, String currentCID<span class="comment">/*clientId*/</span>, List&lt;MessageQueue&gt; mqAll<span class="comment">/*消息队列集合*/</span>,</span></span><br><span class="line"><span class="params">        List&lt;String&gt; cidAll<span class="comment">/*消费者组里面的所有消费者的clientId*/</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (currentCID == <span class="literal">null</span> || currentCID.length() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;currentCID is empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mqAll == <span class="literal">null</span> || mqAll.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;mqAll is null or mqAll empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cidAll == <span class="literal">null</span> || cidAll.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;cidAll is null or cidAll empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;MessageQueue&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;MessageQueue&gt;();</span><br><span class="line">        <span class="comment">//如果消费者组里的消费者不包含当前这个消费者，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!cidAll.contains(currentCID)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;[BUG] ConsumerGroup: &#123;&#125; The consumerId: &#123;&#125; not in cidAll: &#123;&#125;&quot;</span>,</span><br><span class="line">                consumerGroup,</span><br><span class="line">                currentCID,</span><br><span class="line">                cidAll);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当前消费者在消费者集合里面的位置</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> cidAll.indexOf(currentCID);</span><br><span class="line">        <span class="comment">//队列数对消费者数取模</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mod</span> <span class="operator">=</span> mqAll.size() % cidAll.size();</span><br><span class="line">        <span class="comment">//求当前消费者应该消费几个队列</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">averageSize</span> <span class="operator">=</span></span><br><span class="line">            mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> : (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</span><br><span class="line">                + <span class="number">1</span> : mqAll.size() / cidAll.size());</span><br><span class="line">        <span class="comment">//求当前消费者应该从哪个队列开始消费消息</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">startIndex</span> <span class="operator">=</span> (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod;</span><br><span class="line">        <span class="type">int</span> <span class="variable">range</span> <span class="operator">=</span> Math.min(averageSize, mqAll.size() - startIndex);</span><br><span class="line">        <span class="comment">//将当前消费者应该消费的队列一个一个放进返回结果列表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; range; i++) &#123;</span><br><span class="line">            result.add(mqAll.get((startIndex + i) % mqAll.size()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以发现消费者消费哪些队列是由<code>clientId</code>决定的。</p>
</blockquote>
<p>所以当两个消费者的clientId一样时，调用<code>indexOf</code>方法返回的是一样的结果，所以他们消费的队列是一样的。如上面的例子，总共有4个队列，2个消费者，所以两个消费者只消费了同样的两个队列：<code>queueId=0、queueId=1</code>。</p>
<h2 id="clientId怎么生成"><a href="#clientId怎么生成" class="headerlink" title="clientId怎么生成"></a>clientId怎么生成</h2><p>上面说了消费队列负载均衡的结果和<code>clientId</code>有关，那<code>clientId</code>是怎么生成的？</p>
<p>构建<code>clientId</code>的源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * clientId格式：ip+@+instanceName[+<span class="doctag">@unitName</span>]，通常你会看到形如127.0.0.1@32531这样的clientId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">buildMQClientId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    sb.append(<span class="built_in">this</span>.getClientIP());</span><br><span class="line"></span><br><span class="line">    sb.append(<span class="string">&quot;@&quot;</span>);</span><br><span class="line">    sb.append(<span class="built_in">this</span>.getInstanceName());</span><br><span class="line">    <span class="keyword">if</span> (!UtilAll.isBlank(<span class="built_in">this</span>.unitName)) &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;@&quot;</span>);</span><br><span class="line">        sb.append(<span class="built_in">this</span>.unitName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>clientId用来唯一标识一个<code>MQClientInstance</code>。</p>
</blockquote>
<p>可见<code>clientId</code>是根据<code>instanceName</code>属性、<code>ip</code>、<code>unitName</code>（可选）生成的。</p>
<h2 id="为什么会生成相同的clientId"><a href="#为什么会生成相同的clientId" class="headerlink" title="为什么会生成相同的clientId"></a>为什么会生成相同的clientId</h2><p>根据上面<code>clientId</code>的生成规则，两个消费者都在本地启动，意味着有相同的<code>ip</code>，<code>unitName</code>没有设置。</p>
<p><strong>正巧两个消费者设置了相同的<code>instanceName</code>，那生成的<code>clientId</code>必然相同！，这就是问题的关键所在</strong>。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>经过上面分析知道了是<code>clientId</code>相同是问题所在，那解决方案就是让两个消费者的<code>clientId</code>不相同。</p>
<p>根据<br><img src="https://img-blog.csdnimg.cn/20210429174414159.png" alt="在这里插入图片描述"><br>那最简单的解决方案有如下三种：</p>
<h2 id="方案一：不设置instanceName属性"><a href="#方案一：不设置instanceName属性" class="headerlink" title="方案一：不设置instanceName属性"></a>方案一：不设置instanceName属性</h2><p>因为集群模式下<code>instanceName</code>默认值为进程id，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 如果是集群消费模式，如果instanceName是默认值（即没有自定义该属性）则通过进程id来替换该属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeInstanceNameToPID</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.instanceName.equals(<span class="string">&quot;DEFAULT&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.instanceName = String.valueOf(UtilAll.getPid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个消费者的进程id肯定是不同的。</p>
<h2 id="方案二：两个消费者设置不同的instanceName属性"><a href="#方案二：两个消费者设置不同的instanceName属性" class="headerlink" title="方案二：两个消费者设置不同的instanceName属性"></a>方案二：两个消费者设置不同的instanceName属性</h2><p>这个很容易能想到，不必多说。</p>
<h2 id="方案三：两个消费者在不同的机器上启动"><a href="#方案三：两个消费者在不同的机器上启动" class="headerlink" title="方案三：两个消费者在不同的机器上启动"></a>方案三：两个消费者在不同的机器上启动</h2><p><img src="https://img-blog.csdnimg.cn/20210429182720753.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4NTE1MTU1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>在不同机器上启动意味着<code>ip</code>是不一样的，也可以使生成的<code>clientId</code>不同。</p>
<h2 id="正常的消费结果"><a href="#正常的消费结果" class="headerlink" title="正常的消费结果"></a>正常的消费结果</h2><p>通过上述解决方案，最终得到了正确的消费结果。</p>
<p>consumer1:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ConsumeMessageThread_16 接收到新消息: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">2</span></span><br><span class="line">ConsumeMessageThread_17 接收到新消息: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">3</span></span><br><span class="line">ConsumeMessageThread_18 接收到新消息: queueId=<span class="number">0</span>,消息内容: Hello RocketMQ <span class="number">6</span></span><br><span class="line">ConsumeMessageThread_19 接收到新消息: queueId=<span class="number">1</span>,消息内容: Hello RocketMQ <span class="number">7</span> </span><br></pre></td></tr></table></figure>
<p>consumer2:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ConsumeMessageThread_6 接收到新消息: queueId=<span class="number">2</span>,消息内容: Hello RocketMQ <span class="number">0</span></span><br><span class="line">ConsumeMessageThread_7 接收到新消息: queueId=<span class="number">3</span>,消息内容: Hello RocketMQ <span class="number">1</span></span><br><span class="line">ConsumeMessageThread_8 接收到新消息: queueId=<span class="number">2</span>,消息内容: Hello RocketMQ <span class="number">4</span></span><br><span class="line">ConsumeMessageThread_9 接收到新消息: queueId=<span class="number">3</span>,消息内容: Hello RocketMQ <span class="number">5</span></span><br><span class="line">ConsumeMessageThread_10 接收到新消息: queueId=<span class="number">2</span>,消息内容: Hello RocketMQ <span class="number">8</span></span><br><span class="line">ConsumeMessageThread_11 接收到新消息: queueId=<span class="number">3</span>,消息内容: Hello RocketMQ <span class="number">9</span></span><br></pre></td></tr></table></figure>
<p>10条消息被两个消费者消费完成，从消费结果可以看出消息消费的队列分配情况如下所示：<br><img src="https://img-blog.csdnimg.cn/20210429103705492.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE4NTE1MTU1,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<blockquote>
<p>队列被两个消费者平均分配，但是注意，队列均分不代表消息均分！</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>通过这次的问题跟踪排查和解决，越来越意识到对一个中间件原理甚至源码熟悉的重要性。当了解了其整体架构、运作原理以及模块源码以后就能够很快判断出大概是哪里出了问题，这最终也会沉淀为我们的个人经验。</p>
</div><div class="tags"><a href="/tags/RocketMQ/"><i class="fa fa-tag"></i>RocketMQ</a></div><div class="post-nav"><a class="pre" href="/2020/06/22/apollo-auto-refresh/">基于Apollo的配置自动刷新组件</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Apollo/" style="font-size: 15px;">Apollo</a> <a href="/tags/SpringBoot/" style="font-size: 15px;">SpringBoot</a> <a href="/tags/Canal/" style="font-size: 15px;">Canal</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/RocketMQ/" style="font-size: 15px;">RocketMQ</a> <a href="/tags/Gson/" style="font-size: 15px;">Gson</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">多线程</a> <a href="/tags/GitLab/" style="font-size: 15px;">GitLab</a> <a href="/tags/WebHook/" style="font-size: 15px;">WebHook</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/Swagger/" style="font-size: 15px;">Swagger</a> <a href="/tags/ServiceMesh/" style="font-size: 15px;">ServiceMesh</a> <a href="/tags/Skywalking/" style="font-size: 15px;">Skywalking</a> <a href="/tags/ES/" style="font-size: 15px;">ES</a> <a href="/tags/MongoDB/" style="font-size: 15px;">MongoDB</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/06/25/print-xyz/">使用三个线程，按顺序打印X，Y，Z，连续打印10次</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/19/enhance-jdk-proxy-v2/">实现一个增强版的JDK动态代理V2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/enhance-jdk-proxy-v1/">实现一个增强版的JDK动态代理V1.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/13/mybatis-plugin/">这么强大的Mybatis插件机制原来就是这？</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/10/spring-circle-depence/">探索Spring循环依赖的细节</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/12/skywalking-plugin-principle/">Skywalking如何通过修改字节码让插件生效</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/26/gson-serialize-fail/">Gson序列化LinkedHashMap.Entry失败的探索</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/20/springboot-es-mongodb/">SpringBoot中使用ES和MongoDB常用API</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/20/java-complier-optimization/">又长见识了！JVM编译优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/swagger+yapi/">Swagger API Spec + Swagger Codegen + YAPI管理接口文档</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.csdn.net/qq_18515155" title="CSDN-徐小陌的博客" target="_blank">CSDN-徐小陌的博客</a><ul></ul><a href="https://www.zhihu.com/people/xu-jian-1-1" title="知乎-倔强的码农" target="_blank">知乎-倔强的码农</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">墨鱼🦑的个人博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>